<!DOCTYPE html>
<html lang="ko">
<head>
    <script>
        (function() {
            // [ë³´ì•ˆ 1] ê²½ë¡œ ì„¤ì • (ê´€ë¦¬ì í˜ì´ì§€ê°€ í´ë” ë°–ì— ìˆë‹¤ë©´ 'start/lock.html')
            // í˜„ì¬ ìœ„ì¹˜ì—ì„œ start í´ë” ì•ˆì˜ lock.htmlì„ ì°¾ì•„ê°€ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
            const redirectPath = 'start/lock.html'; 

            // [ë³´ì•ˆ 2] ì¶œì…ì¦ í™•ì¸ (ê´€ë¦¬ì ì¸ì¦ í‚¤ì¸ 'admin_auth'ë¡œ ê²€ì‚¬)
            if (sessionStorage.getItem('admin_auth') !== 'granted') {
                window.location.replace(redirectPath);
                return;
            }

            const evict = () => window.location.replace(redirectPath);

            // [ë³´ì•ˆ 3] ë©”ì¸ ê°ì‹œ ì—”ì§„ (ì‹¤ì‹œê°„ ë””ë²„ê±° ê°ì‹œ)
            setInterval(function() {
                const start = Date.now();
                debugger; 
                if (Date.now() - start > 100) {
                    evict();
                }
            }, 200);

            // [ë³´ì•ˆ 4] ë‹¨ì¶•í‚¤ ë° ìš°í´ë¦­ ì›ì²œ ì°¨ë‹¨
            document.addEventListener('contextmenu', e => e.preventDefault());
            window.addEventListener('keydown', function(e) {
                // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U ì°¨ë‹¨
                if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && [73, 74].includes(e.keyCode)) || (e.ctrlKey && e.keyCode === 85)) {
                    e.preventDefault();
                    evict();
                }
            });
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ê´€ì œ ì„¼í„° - ì˜¤ë‹µ í’€ì´ ìˆ˜ì—… ëª¨ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* [1. ë””ìì¸ í†µí•© ì„¤ì •ì°½] */
        :root { 
            --primary: #2563eb; 
            --bg: #f1f5f9; 
            --card: #ffffff; 
            --text: #1e293b; 
            --admin-font-size: 16px; 

            /* ğŸ” ë‹ë³´ê¸° ì¡°ì ˆ ëŒ€ìƒ (ë¬¸ì œ/ë³´ê¸°/í•´ì„¤) */
            --modal-q-size: 1.5rem;   
            --modal-exp-size: 1.2rem; 

            /* ğŸ¨ ì •ë‹µ/ì˜¤ë‹µ ë°°ì§€ ìƒ‰ìƒ */
            --color-correct: #16a34a; 
            --color-wrong: #dc2626;   

            /* ğŸ•µï¸ ì‹œí¬ë¦¿ ì •ë‹µ ìƒ‰ìƒ */
            --secret-ans-color: #f3f4f6; 
        }
        
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-size: var(--admin-font-size); line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; }

        /* [ì‹ ê·œ] ğŸ“Š ë°ì´í„° ê´€ì œ ëª¨ë‹ˆí„° ìŠ¤íƒ€ì¼ */
        .usage-monitor { background: #1e293b; color: white; padding: 15px 25px; border-radius: 12px; display: flex; gap: 30px; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .usage-item { display: flex; flex-direction: column; gap: 6px; align-items: center; text-align: center; flex: 1; }
        .usage-label { font-size: 0.8rem; color: #94a3b8; font-weight: 700; line-height: 1.3; }
        .usage-value { font-size: 1.1rem; font-weight: 900; color: #f8fafc; }
        .usage-bar-bg { width: 150px; height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .usage-bar-fill { height: 100%; background: #38bdf8; width: 0%; transition: 0.8s ease-out; }

        .admin-controls { background: var(--card); padding: 15px 25px; border-radius: 12px; display: flex; gap: 20px; align-items: center; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .view-mode-selector { display: flex; gap: 8px; }
        .mode-btn { 
            padding: 8px 16px; border-radius: 8px; border: 2px solid #e2e8f0; 
            background: #ffffff; color: #64748b; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .tab-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { 
            flex: 1; padding: 15px; border-radius: 12px; border: none; 
            font-size: 1.1rem; font-weight: 900; cursor: pointer; transition: 0.3s;
            background: #e2e8f0; color: #64748b;
        }
        .tab-btn.active { background: #1e293b; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .date-group { margin-bottom: 15px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .date-header { background: var(--primary); color: white; padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 1.1rem; font-weight: 700; }
        .date-content { background: white; overflow-x: auto; }
        .date-content.collapsed { display: none; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; padding: 15px; font-size: 0.95rem; border-bottom: 2px solid #e2e8f0; color: #64748b; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .btn-view { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-del { background: #fee2e2; color: #ef4444; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .btn-multi-del { background: #ef4444; color: white; display: none; margin-left: 10px; }

        .status-badge { padding: 4px 10px; border-radius: 6px; font-weight: 800; font-size: 0.85rem; }
        .status-success { background: #dcfce7; color: #166534; }
        .status-fail { background: #fee2e2; color: #991b1b; }

        #result-modal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.95); z-index:10000; }
        .modal-body { background: white; width: 100vw; height: 100vh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
        .modal-sticky-header { background: #ffffff; padding: 15px 40px; border-bottom: 3px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-scroll-area { flex: 1; overflow-y: auto; padding: 40px; background: #f8fafc; scroll-behavior: smooth; }

        .result-card { background: white; border-radius: 20px; padding: 35px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: 2px solid #e2e8f0; }
        .card-top-row { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .q-number-badge { display: inline-block; padding: 6px 18px; border-radius: 50px; font-weight: 900; font-size: 1rem; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .badge-correct { background-color: var(--color-correct); }
        .badge-wrong { background-color: var(--color-wrong); }
        .ans-correct-line { font-size: 1.3rem !important; color: var(--secret-ans-color); font-weight: 700; user-select: text; -webkit-user-select: text; }
        .ans-correct-line::selection { background: var(--primary); color: white; }
        .q-title { font-size: var(--modal-q-size); font-weight: 900; color: #000; margin-bottom: 25px; word-break: keep-all; }
        .q-options-area { font-size: calc(var(--modal-q-size) * 0.85); color: #333; font-weight: 400; margin-bottom: 20px; border-top: 1px dashed #ddd; padding-top: 15px; }
        .option-item { margin-bottom: 8px; display: block; }
        .student-ans-line { font-size: 1rem !important; color: #94a3b8; font-weight: 400; margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 10px; }
        .exp-box { font-size: var(--modal-exp-size); line-height: 1.7; background: #f8fafc; padding: 25px; border-radius: 15px; margin-top: 15px; color: #475569; border: 1px solid #e2e8f0; }

        .one-by-one-nav { display: none; justify-content: center; align-items: center; gap: 40px; padding: 20px; background: white; border-top: 3px solid #e2e8f0; }
        .mode-active-one #student-report-header { display: none !important; }
        .mode-active-one .one-by-one-nav { display: flex; }
        .mode-active-one .result-card { display: none; }
        .mode-active-one .result-card.active { display: block; animation: fadeIn 0.3s ease-in-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media screen and (max-width: 768px) {
            body { padding: 10px; font-size: var(--admin-font-size); } 
            header { flex-direction: column; align-items: flex-start !important; gap: 5px; margin-bottom: 15px; }
            header h1 { font-size: 1rem !important; }
            /* ğŸ“Š ëª¨ë°”ì¼ ë² ë„ˆ ìµœì í™” (ì œëª© 2ì¤„ + ê°€ìš´ë° ì •ë ¬ ë²„ì „) */
            .usage-monitor { flex-direction: row; gap: 8px; padding: 10px; margin-bottom: 10px; justify-content: space-between; align-items: stretch; }
            .usage-item { flex: 1; gap: 2px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; }
            .usage-label { font-size: 0.6rem; line-height: 1.2; word-break: keep-all; height: 1.6rem; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-weight: 700; }
            .usage-value { font-size: 0.75rem; white-space: nowrap; font-weight: 900; color: #f8fafc; }
            .usage-bar-bg { width: 100%; height: 5px; margin-top: 2px; }
          
            .admin-controls { padding: 10px; flex-direction: column; align-items: flex-start; gap: 10px; }
            .admin-controls div { font-size: 14px; width: 100%; }
            .admin-controls button { width: 100%; font-size: 14px; padding: 8px; }
            .date-header { padding: 12px 15px; font-size: 0.9rem; }
            table { min-width: 480px; } 
            th, td { padding: 8px 4px; font-size: calc(var(--admin-font-size) * 0.65); } 
            .btn-view, .btn-del { padding: 6px 10px; font-size: calc(var(--admin-font-size) * 0.7); }
            .modal-sticky-header { padding: 10px; flex-direction: column; gap: 8px; }
            .modal-scroll-area { padding: 15px; }
            .result-card { padding: 20px; }
            .card-top-row { flex-direction: column; align-items: flex-start; gap: 8px; }
            .ans-correct-line { font-size: 0.8rem !important; }
            /* ğŸ“± ëª¨ë°”ì¼ ë¦¬í¬íŠ¸ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìŠ¬ë¦¼í™” */
            .one-by-one-nav { padding: 10px; gap: 15px; } /* ì „ì²´ ë°”ì˜ ë†’ì´ì™€ ê°„ê²© ì¶•ì†Œ */
            .one-by-one-nav .btn-view { padding: 8px 15px !important; font-size: 0.9rem !important; } /* ë²„íŠ¼ í¬ê¸°ì™€ ê¸€ì”¨ ëŒ€í­ ì¶•ì†Œ */
            #page-indicator { font-size: 1.2rem !important; min-width: 80px !important; } /* í˜ì´ì§€ í‘œì‹œ ìˆ«ì í¬ê¸° ì¡°ì ˆ */
        }
    </style>
</head>
<body>

<div class="container">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1 style="font-weight:900; color:var(--primary); font-size: 2.2rem;">ğŸš€ ìë™ì°¨ ì •ë¹„ êµìœ¡ ê´€ì œ ì‹œìŠ¤í…œ</h1>
        <button class="btn-del" style="background:#475569; color:white;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </header>

    <div class="usage-monitor">
        <div class="usage-item">
            <span class="usage-label">ğŸ“¦ ì €ì¥ ë°ì´í„° ì‹¤ì‹œê°„ ìš©ëŸ‰<br>(ìµœëŒ€ 1GB)</span>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="usage-bar-bg"><div id="usage-bar" class="usage-bar-fill"></div></div>
                <span id="usage-percent" class="usage-value">0% (0MB)</span>
            </div>
        </div>
        <div class="usage-item">
            <span class="usage-label">ğŸ“… íŠ¸ë˜í”½ ì´ˆê¸°í™” ë””ë°ì´<br>(ë§¤ì›” 1ì¼)</span>
            <span id="reset-dday" class="usage-value">D-?</span>
        </div>
        <div class="usage-item">
            <span class="usage-label">ğŸ“‹ í˜„ì¬ ëˆ„ì  ê¸°ë¡</span>
            <span id="total-records-count" class="usage-value">0ê±´</span>
        </div>
    </div>

    <div class="tab-selector">
        <button id="tab-exam" class="tab-btn active" onclick="switchMainTab('exam')">ğŸ“ í•™ìƒ ì‹œí—˜ ê¸°ë¡</button>
        <button id="tab-log" class="tab-btn" onclick="switchMainTab('log')">ğŸ›¡ï¸ ê´€ë¦¬ì ì ‘ì† ê¸°ë¡</button>
    </div>

    <div id="exam-controls" class="admin-controls">
        <div class="view-mode-selector">
            <button id="mode-date" class="mode-btn active" onclick="updateViewMode('date')">ğŸ“… ìš”ì¼ë³„</button>
            <button id="mode-class" class="mode-btn" onclick="updateViewMode('class')">ğŸ« êµì‹¤ë³„</button>
        </div>
        <button id="btn-multi-delete" class="btn-view btn-multi-del" onclick="deleteSelectedRecords()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ (<span id="selected-count">0</span>)</button>
        
        <div style="display:flex; align-items:center; gap:15px;"><span style="font-weight:700;">ğŸ–¥ï¸ ë©”ì¸ í°íŠ¸:</span><input type="range" min="14" max="24" value="16" oninput="updateAdminStyle('size', this.value)"><span id="admin-size-val">16px</span></div>
        <div style="margin-left:auto;"><button class="btn-view" style="background:#10b981;" onclick="location.reload()">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button></div>
    </div>

    <div id="log-controls" class="admin-controls" style="display:none;">
        <div style="font-weight:900; color:#1e293b;">ğŸ•µï¸ ê´€ë¦¬ì ëª¨ë“œ ì ‘ì† ì‹œë„ ë¸”ë™ë°•ìŠ¤</div>
        <div style="margin-left:auto;"><button class="btn-del" onclick="clearAdminLogs()">âš ï¸ ì „ì²´ ë¡œê·¸ ì´ˆê¸°í™”</button></div>
    </div>

    <div id="dashboard-content">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
</div>

<div id="result-modal">
    <div class="modal-body" id="modal-frame">
        <div class="modal-sticky-header">
            <div style="display:flex; gap:30px; align-items:center;">
                <div style="display:flex; gap:15px; align-items:center;">
                    <span style="font-weight:900; color:var(--primary); font-size:1.1rem;">ğŸ” í•´ì„¤ ë‹ë³´ê¸°:</span>
                    <input type="range" min="1" max="5" step="0.1" value="1.5" style="width:200px; cursor:pointer;" oninput="updateModalFont(this.value)">
                    <span id="modal-q-val" style="font-weight:800; color:var(--primary); min-width:60px;">1.5rem</span>
                </div>
            </div>
            <div style="display:flex; gap:15px;">
                <button class="btn-view" id="toggle-view-mode" onclick="toggleDisplayMode()" style="background:#6366f1; padding:12px 25px;">ğŸ“± í•œë¬¸ì œì”© ë³´ê¸° ì „í™˜</button>
                <button class="btn-del" onclick="closeModal()" style="font-size:1.1rem; padding:10px 25px;">ë‹«ê¸° (ESC)</button>
            </div>
        </div>
        <div class="modal-scroll-area" id="modal-inner-content"></div>
        <div class="one-by-one-nav" id="one-nav">
            <button class="btn-view" onclick="changeStep(-1)" style="background:#64748b; padding:15px 30px; font-size:1.2rem;">â—€ ì´ì „ ë¬¸ì œ</button>
            <span id="page-indicator" style="font-weight:900; font-size:1.8rem; color:var(--primary); min-width:120px; text-align:center;">1 / 20</span>
            <button class="btn-view" onclick="changeStep(1)" style="padding:15px 30px; font-size:1.2rem;">ë‹¤ìŒ ë¬¸ì œ â–¶</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB3lciTRWoJ1aXQQJH6JgNC4aJnXj6Ewog",
        authDomain: "khj-cbtbase.firebaseapp.com",
        databaseURL: "https://khj-cbtbase-default-rtdb.firebaseio.com",
        projectId: "khj-cbtbase",
        storageBucket: "khj-cbtbase.firebasestorage.app",
        messagingSenderId: "430706982133",
        appId: "1:430706982133:web:d0bf4cb620f1c7d263d9bc"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    if (sessionStorage.getItem('admin_auth') !== 'granted') location.replace('index.html');

    let currentMainTab = 'exam'; 
    let rawExamData = null;
    let rawLogData = null;
    let viewMode = 'date';

    // [ì‹ ê·œ ë¡œì§] ë°ì´í„° ìš©ëŸ‰ ë° ì´ˆê¸°í™” ë””ë°ì´ ê³„ì‚° í•¨ìˆ˜
    function updateUsageMonitor(data) {
        if (!data) {
            document.getElementById('usage-percent').innerText = "0% (0MB)";
            document.getElementById('usage-bar').style.width = "0%";
            document.getElementById('total-records-count').innerText = "0ê±´";
            return;
        }

        const totalRecords = Object.keys(data).length;
        document.getElementById('total-records-count').innerText = `${totalRecords}ê±´`;

        // ë¬¸ìì—´ í¬ê¸°ë¡œ ëŒ€ëµì ì¸ MB ê³„ì‚° (1MB = 1,048,576 bytes)
        const jsonString = JSON.stringify(data);
        const bytes = new Blob([jsonString]).size;
        const mb = bytes / (1024 * 1024);
        const percent = (mb / 1024 * 100).toFixed(3); // 1GB ê¸°ì¤€

        const bar = document.getElementById('usage-bar');
        const percentSpan = document.getElementById('usage-percent');

        bar.style.width = Math.max(percent, 0.5) + '%'; // ìµœì†Œ ê°€ë…ì„± í™•ë³´
        percentSpan.innerText = `${percent}% (${mb.toFixed(2)}MB)`;

        // ìƒ‰ìƒ ê²½ê³  (80% ë„˜ìœ¼ë©´ ë¹¨ê°„ìƒ‰)
        if (percent > 80) bar.style.background = "#ef4444";
        else bar.style.background = "#38bdf8";

        // ì´ˆê¸°í™” ë””ë°ì´ ê³„ì‚° (ë§¤ì›” 1ì¼)
        const now = new Date();
        const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        const diff = Math.ceil((nextMonth - now) / (1000 * 60 * 60 * 24));
        document.getElementById('reset-dday').innerText = `D-${diff} (${nextMonth.getMonth() + 1}ì›” 1ì¼ ë¦¬ì…‹)`;
    }

    window.switchMainTab = (tab) => {
        currentMainTab = tab;
        document.getElementById('tab-exam').classList.toggle('active', tab === 'exam');
        document.getElementById('tab-log').classList.toggle('active', tab === 'log');
        document.getElementById('exam-controls').style.display = tab === 'exam' ? 'flex' : 'none';
        document.getElementById('log-controls').style.display = tab === 'log' ? 'flex' : 'none';
        refreshDashboard();
    };

    // ë°ì´í„° ê°ì‹œ ë° ëª¨ë‹ˆí„°ë§ ì—°ë™
    onValue(ref(database, 'exam_results'), (snapshot) => {
        rawExamData = snapshot.val();
        updateUsageMonitor(rawExamData); // ê³„ê¸°íŒ ê°±ì‹ 
        if (currentMainTab === 'exam') refreshDashboard();
    });

    onValue(ref(database, 'admin_access_logs'), (snapshot) => {
        rawLogData = snapshot.val();
        if (currentMainTab === 'log') refreshDashboard();
    });

    function refreshDashboard() {
        if (currentMainTab === 'exam') renderExamDashboard(rawExamData);
        else renderLogDashboard(rawLogData);
    }

    // [1] í•™ìƒ ì‹œí—˜ ê¸°ë¡ ë Œë”ë§
    function renderExamDashboard(data) {
        const dashboard = document.getElementById('dashboard-content');
        dashboard.innerHTML = '';
        if (!data) { dashboard.innerHTML = '<p style="text-align:center; padding:50px;">ì‹œí—˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
        
        const groups = {};
        Object.entries(data).forEach(([key, val]) => {
            const groupKey = (viewMode === 'date') ? val.date.split(' ')[0] : (val.class || 'ë¯¸ê¸°ì¬');
            if (!groups[groupKey]) groups[groupKey] = [];
            groups[groupKey].push({ key, ...val });
        });

        const sortedKeys = Object.keys(groups).sort((a, b) => {
            if (viewMode === 'date') return new Date(b) - new Date(a);
            return a.localeCompare(b, undefined, {numeric: true});
        });

        sortedKeys.forEach(groupTitle => {
            const students = groups[groupTitle].sort((a, b) => new Date(b.date.replace(/-/g, '/')) - new Date(a.date.replace(/-/g, '/')));
            const groupSection = document.createElement('div');
            groupSection.className = 'date-group';
            const headerIcon = (viewMode === 'date') ? 'ğŸ“…' : 'ğŸ«';
            const headerSuffix = (viewMode === 'date') ? 'ëª…ë‹¨' : 'í˜¸ êµì‹¤ ëª…ë‹¨';

            groupSection.innerHTML = `
                <div class="date-header" onclick="this.nextElementSibling.classList.toggle('collapsed')">
                    <span>${headerIcon} ${groupTitle}${headerSuffix}</span>
                    <span>ì´ ${students.length}ëª… â–¼</span>
                </div>
                <div class="date-content">
                    <table>
                        <thead><tr>
                            <th><input type="checkbox" onclick="toggleAllInGroup(this)"></th>
                            <th>êµì‹¤</th><th>ì‹œê°„</th><th>ì´ë¦„</th><th>ê³¼ëª©</th><th>íšŒì°¨</th><th>ì ìˆ˜</th><th>ì‘ì—…</th>
                        </tr></thead>
                        <tbody>
                        ${students.map(s => `
                            <tr>
                                <td><input type="checkbox" class="row-check" value="exam_results/${s.key}" onchange="updateMultiDelCount()"></td>
                                <td style="font-weight:700; color:var(--primary);">${s.class || '-'}í˜¸</td>
                                <td style="font-weight:700;">${formatTo24H(s.date)}</td>
                                <td><strong>${s.name}</strong></td>
                                <td>${s.subject}</td>
                                <td>${s.round}</td>
                                <td style="color:var(--primary); font-weight:900;">${s.score}ì </td>
                                <td>
                                    <button class="btn-view" onclick='showDetails(${JSON.stringify(s).replace(/'/g, "&apos;")})'>ë¦¬í¬íŠ¸</button>
                                    <button class="btn-del" onclick="deleteRecord('exam_results/${s.key}')" style="margin-left:4px;">ì‚­ì œ</button>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>`;
            dashboard.appendChild(groupSection);
        });
        updateMultiDelCount(); 
    }

    // [2] ê´€ë¦¬ì ì ‘ì† ë¡œê·¸ ë Œë”ë§
    function renderLogDashboard(data) {
        const dashboard = document.getElementById('dashboard-content');
        dashboard.innerHTML = '';
        if (!data) { dashboard.innerHTML = '<p style="text-align:center; padding:50px;">ì ‘ì† ê¸°ë¡ì´ ê¹¨ë—í•©ë‹ˆë‹¤. (ì•ˆì „)</p>'; return; }

        const logs = Object.entries(data).map(([key, val]) => ({ key, ...val }))
                     .sort((a, b) => new Date(b.date.replace(/-/g, '/')) - new Date(a.date.replace(/-/g, '/')));

        const logSection = document.createElement('div');
        logSection.className = 'date-group';
        logSection.innerHTML = `
            <div class="date-header" style="background:#1e293b;">
                <span>ğŸ›¡ï¸ ê´€ë¦¬ì ëª¨ë“œ ì ‘ì† ì‹œë„ ì „ì²´ ë¡œê·¸</span>
                <span>ì´ ${logs.length}ê±´</span>
            </div>
            <div class="date-content">
                <table>
                    <thead><tr><th>ìƒíƒœ</th><th>ì‹œë„ ì¼ì‹œ</th><th>êµì‹¤</th><th>ì´ë¦„</th><th>ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸</th><th>ì ‘ì† ê¸°ê¸°</th><th>ì‘ì—…</th></tr></thead>
                    <tbody>
                    ${logs.map(l => `
                        <tr>
                            <td><span class="status-badge ${l.status === 'SUCCESS' ? 'status-success' : 'status-fail'}">${l.status}</span></td>
                            <td style="font-weight:700;">${l.date}</td>
                            <td>${l.class || '-'}</td>
                            <td><strong>${l.name || 'ì•Œìˆ˜ì—†ìŒ'}</strong></td>
                            <td style="color:${l.status === 'FAIL' ? '#ef4444' : '#64748b'}; font-family:monospace;">${l.attemptPw || '****'}</td>
                            <td style="font-size:0.75rem; color:#64748b; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${l.device}</td>
                            <td><button class="btn-del" onclick="deleteRecord('admin_access_logs/${l.key}')">ê¸°ë¡ì‚­ì œ</button></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
        dashboard.appendChild(logSection);
    }

    // ë‹¤ì¤‘ ì‚­ì œ ë¡œì§
    window.toggleAllInGroup = (headerChk) => {
        const table = headerChk.closest('table');
        const checkboxes = table.querySelectorAll('.row-check');
        checkboxes.forEach(chk => chk.checked = headerChk.checked);
        updateMultiDelCount();
    };

    window.updateMultiDelCount = () => {
        const checkedBoxes = document.querySelectorAll('.row-check:checked');
        const count = checkedBoxes.length;
        const btn = document.getElementById('btn-multi-delete');
        document.getElementById('selected-count').innerText = count;
        btn.style.display = count > 0 ? 'block' : 'none';
    };

    window.deleteSelectedRecords = async () => {
        const checkedBoxes = document.querySelectorAll('.row-check:checked');
        if (confirm(`âš ï¸ ì„ íƒí•œ ${checkedBoxes.length}ê°œì˜ ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            for (let chk of checkedBoxes) {
                await remove(ref(database, chk.value));
            }
            alert("ì‚­ì œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            updateMultiDelCount();
        }
    };

    window.updateViewMode = (mode) => {
        viewMode = mode;
        document.getElementById('mode-date').classList.toggle('active', mode === 'date');
        document.getElementById('mode-class').classList.toggle('active', mode === 'class');
        refreshDashboard();
    };

    function formatTo24H(dateStr) {
        if (!dateStr) return "00ì‹œ 00ë¶„";
        const parts = dateStr.split(' ');
        if (parts.length < 2) return dateStr;
        const timePart = parts[1];
        const [hour, min] = timePart.split(':');
        return `${hour.padStart(2, '0')}ì‹œ ${min.padStart(2, '0')}ë¶„`;
    }

    window.deleteRecord = (path) => { if(confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) remove(ref(database, path)); };
    window.clearAdminLogs = () => { if(confirm("âš ï¸ ëª¨ë“  ì ‘ì† ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•™ìƒ ê¸°ë¡ì€ ìœ ì§€ë©ë‹ˆë‹¤.")) remove(ref(database, 'admin_access_logs')); };

    let currentStep = 0; let totalSteps = 0; let isOneByOneMode = false;

    window.showDetails = (data) => {
        isOneByOneMode = false;
        document.getElementById('modal-frame').classList.remove('mode-active-one');
        const content = document.getElementById('modal-inner-content');
        if (!data.wrongList) { alert("ìƒì„¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        totalSteps = data.wrongList.length; currentStep = 0;

        let html = `<div id="student-report-header" style="background:var(--primary); color:white; padding:30px; border-radius:20px; margin-bottom:40px;">
            <div style="font-size:0.9rem; margin-bottom:5px; opacity:0.8;">[${data.class || '-'}í˜¸ êµì‹¤]</div>
            <div style="font-size:1.5rem; font-weight:900;">${data.name} í•™ìƒ ë¶„ì„ ë¦¬í¬íŠ¸ (${data.score}ì )</div>
        </div>`;

        html += data.wrongList.map((item, i) => {
            const isCorrect = item.isCorrect === true;
            const badgeClass = isCorrect ? 'badge-correct' : 'badge-wrong';
            const statusIcon = isCorrect ? 'âœ…' : 'âŒ';
            let optionsHtml = item.options ? `<div class="q-options-area"><strong>ì‹¤ì œ ë³´ê¸°</strong><br>${item.options.map((opt, idx) => `<span class="option-item">${idx+1}. ${opt}</span>`).join('')}</div>` : '';
            return `<div class="result-card ${i === 0 ? 'active' : ''}" id="card-${i}">
                <div class="card-top-row"><div class="q-number-badge ${badgeClass}">${statusIcon} Question ${i+1}</div><div class="ans-correct-line">ì •ë‹µ í•´ì„¤: ${item.correct}</div></div>
                <div class="q-title">Q. ${item.q}</div>${optionsHtml}<div class="student-ans-line">í•™ìƒ ë‹µë³€ ê¸°ë¡: ${item.user || 'ë¯¸ì…ë ¥'}</div><div class="exp-box"><strong>ğŸ“– í•´ì„¤</strong><br>${item.explain || 'í•´ì„¤ì´ ì—†ìŠµë‹ˆë‹¤.'}</div></div>`;
        }).join('');
        content.innerHTML = html;
        document.getElementById('result-modal').style.display = 'block';
        updatePageIndicator();
    };

    window.updateModalFont = (val) => {
        document.documentElement.style.setProperty('--modal-q-size', val + 'rem');
        document.documentElement.style.setProperty('--modal-exp-size', (val * 0.75) + 'rem');
        document.getElementById('modal-q-val').innerText = val + 'rem';
    };

    window.toggleDisplayMode = () => { isOneByOneMode = !isOneByOneMode; const frame = document.getElementById('modal-frame'); if(isOneByOneMode) { frame.classList.add('mode-active-one'); } else { frame.classList.remove('mode-active-one'); } };
    window.changeStep = (dir) => { const next = currentStep + dir; if (next >= 0 && next < totalSteps) { document.getElementById(`card-${currentStep}`).classList.remove('active'); currentStep = next; document.getElementById(`card-${currentStep}`).classList.add('active'); updatePageIndicator(); } };
    function updatePageIndicator() { document.getElementById('page-indicator').innerText = `${currentStep + 1} / ${totalSteps}`; }
    window.closeModal = () => { document.getElementById('result-modal').style.display = 'none'; };
    window.updateAdminStyle = (size, val) => { document.documentElement.style.setProperty('--admin-font-size', val + 'px'); document.getElementById('admin-size-val').innerText = val + 'px'; };
    window.logout = () => { sessionStorage.removeItem('admin_auth'); location.replace('index.html'); };
    window.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); if(isOneByOneMode) { if(e.key === 'ArrowRight') changeStep(1); if(e.key === 'ArrowLeft') changeStep(-1); } });
</script>
</body>
</html>