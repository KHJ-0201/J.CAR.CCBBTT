<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ê´€ì œ ì„¼í„° - ì˜¤ë‹µ í’€ì´ ìˆ˜ì—… ëª¨ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* [1. ë””ìì¸ í†µí•© ì„¤ì •ì°½] */
        :root { 
            --primary: #2563eb; 
            --bg: #f1f5f9; 
            --card: #ffffff; 
            --text: #1e293b; 
            --admin-font-size: 16px; 

            /* ğŸ” ë‹ë³´ê¸° ì¡°ì ˆ ëŒ€ìƒ (ë¬¸ì œ/ë³´ê¸°/í•´ì„¤) */
            --modal-q-size: 1.5rem;   
            --modal-exp-size: 1.2rem; 

            /* ğŸ¨ ì •ë‹µ/ì˜¤ë‹µ ë°°ì§€ ìƒ‰ìƒ */
            --color-correct: #16a34a; 
            --color-wrong: #dc2626;   

            /* ğŸ•µï¸ ì‹œí¬ë¦¿ ì •ë‹µ ìƒ‰ìƒ (ë°°ê²½ìƒ‰ê³¼ ë¹„ìŠ·í•˜ê²Œ ì„¤ì •) */
            --secret-ans-color: #f3f4f6; 
        }
        
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-size: var(--admin-font-size); line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; }
        .admin-controls { background: var(--card); padding: 15px 25px; border-radius: 12px; display: flex; gap: 20px; align-items: center; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .date-group { margin-bottom: 15px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .date-header { background: var(--primary); color: white; padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 1.1rem; font-weight: 700; }
        .date-content { background: white; overflow-x: auto; }
        .date-content.collapsed { display: none; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; padding: 15px; font-size: 0.95rem; border-bottom: 2px solid #e2e8f0; color: #64748b; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .btn-view { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-del { background: #fee2e2; color: #ef4444; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* ê²°ê³¼ ë³´ê¸° ëª¨ë‹¬ (Full Screen) */
        #result-modal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.95); z-index:10000; }
        .modal-body { background: white; width: 100vw; height: 100vh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
        .modal-sticky-header { background: #ffffff; padding: 15px 40px; border-bottom: 3px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-scroll-area { flex: 1; overflow-y: auto; padding: 40px; background: #f8fafc; scroll-behavior: smooth; }

        /* [ìˆ˜ì—…ìš© ì¹´ë“œ ë””ìì¸] */
        .result-card { background: white; border-radius: 20px; padding: 35px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: 2px solid #e2e8f0; }
        
        /* ìƒë‹¨ í—¤ë” ì˜ì—­ (ë°°ì§€ + ì •ë‹µí•´ì„¤ ë‚˜ë€íˆ) */
        .card-top-row { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }

        .q-number-badge {
            display: inline-block;
            padding: 6px 18px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 1rem;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .badge-correct { background-color: var(--color-correct); }
        .badge-wrong { background-color: var(--color-wrong); }

        /* ğŸ” ì •ë‹µ í•´ì„¤ (ì‹œí¬ë¦¿ ëª¨ë“œ + í¬ê¸° 1rem ê³ ì •) */
        .ans-correct-line { 
            font-size: 1.3rem !important; /* ë‹ë³´ê¸° ë¬´ì‹œí•˜ê³  ê³ ì • */
            color: var(--secret-ans-color); 
            font-weight: 700;
            user-select: text; -webkit-user-select: text; 
        }
        .ans-correct-line::selection { background: var(--primary); color: white; }

        /* 1. ë¬¸ì œ */
        .q-title { font-size: var(--modal-q-size); font-weight: 900; color: #000; margin-bottom: 25px; word-break: keep-all; }
        
        /* 2. ì‹¤ì œ ë³´ê¸° */
        .q-options-area { font-size: calc(var(--modal-q-size) * 0.85); color: #333; font-weight: 400; margin-bottom: 20px; border-top: 1px dashed #ddd; padding-top: 15px; }
        .option-item { margin-bottom: 8px; display: block; }

        /* 3. í•™ìƒ ë‹µë³€ (ê³ ì • í¬ê¸°) */
        .student-ans-line { font-size: 1rem !important; color: #94a3b8; font-weight: 400; margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 10px; }

        /* ë¬¸ì œ í•´ì„¤ ë°•ìŠ¤ */
        .exp-box { font-size: var(--modal-exp-size); line-height: 1.7; background: #f8fafc; padding: 25px; border-radius: 15px; margin-top: 15px; color: #475569; border: 1px solid #e2e8f0; }

        /* í•œ ë¬¸ì œì”© ë³´ê¸° ë‚´ë¹„ê²Œì´ì…˜ */
        .one-by-one-nav { display: none; justify-content: center; align-items: center; gap: 40px; padding: 20px; background: white; border-top: 3px solid #e2e8f0; }
        .mode-active-one #student-report-header { display: none !important; }
        .mode-active-one .one-by-one-nav { display: flex; }
        .mode-active-one .result-card { display: none; }
        .mode-active-one .result-card.active { display: block; animation: fadeIn 0.3s ease-in-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h1 style="font-weight:900; color:var(--primary); font-size: 2.2rem;">ğŸš€ ìë™ì°¨ ì •ë¹„ êµìœ¡ ê´€ì œ ì‹œìŠ¤í…œ</h1>
        <button class="btn-del" style="background:#475569; color:white;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </header>
    <div class="admin-controls">
        <div style="display:flex; align-items:center; gap:15px;"><span style="font-weight:700;">ğŸ–¥ï¸ ë©”ì¸ í°íŠ¸:</span><input type="range" min="14" max="24" value="16" oninput="updateAdminStyle('size', this.value)"><span id="admin-size-val">16px</span></div>
        <div style="margin-left:auto;"><button class="btn-view" style="background:#10b981;" onclick="location.reload()">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button></div>
    </div>
    <div id="dashboard-content">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
</div>

<div id="result-modal">
    <div class="modal-body" id="modal-frame">
        <div class="modal-sticky-header">
            <div style="display:flex; gap:30px; align-items:center;">
                <div style="display:flex; gap:15px; align-items:center;">
                    <span style="font-weight:900; color:var(--primary); font-size:1.1rem;">ğŸ” í•´ì„¤ ë‹ë³´ê¸°:</span>
                    <input type="range" min="1" max="5" step="0.1" value="1.5" style="width:200px; cursor:pointer;" oninput="updateModalFont(this.value)">
                    <span id="modal-q-val" style="font-weight:800; color:var(--primary); min-width:60px;">1.5rem</span>
                </div>
            </div>
            <div style="display:flex; gap:15px;">
                <button class="btn-view" id="toggle-view-mode" onclick="toggleDisplayMode()" style="background:#6366f1; padding:12px 25px;">ğŸ“± í•œë¬¸ì œì”© ë³´ê¸° ì „í™˜</button>
                <button class="btn-del" onclick="closeModal()" style="font-size:1.1rem; padding:10px 25px;">ë‹«ê¸° (ESC)</button>
            </div>
        </div>
        <div class="modal-scroll-area" id="modal-inner-content"></div>
        <div class="one-by-one-nav" id="one-nav">
            <button class="btn-view" onclick="changeStep(-1)" style="background:#64748b; padding:15px 30px; font-size:1.2rem;">â—€ ì´ì „ ë¬¸ì œ</button>
            <span id="page-indicator" style="font-weight:900; font-size:1.8rem; color:var(--primary); min-width:120px; text-align:center;">1 / 20</span>
            <button class="btn-view" onclick="changeStep(1)" style="padding:15px 30px; font-size:1.2rem;">ë‹¤ìŒ ë¬¸ì œ â–¶</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB3lciTRWoJ1aXQQJH6JgNC4aJnXj6Ewog",
        authDomain: "khj-cbtbase.firebaseapp.com",
        databaseURL: "https://khj-cbtbase-default-rtdb.firebaseio.com",
        projectId: "khj-cbtbase",
        storageBucket: "khj-cbtbase.firebasestorage.app",
        messagingSenderId: "430706982133",
        appId: "1:430706982133:web:d0bf4cb620f1c7d263d9bc"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    if (sessionStorage.getItem('admin_auth') !== 'granted') location.replace('index.html');

    const examRef = ref(database, 'exam_results');
    onValue(examRef, (snapshot) => {
        const data = snapshot.val();
        if (data) renderDashboard(data);
    });

    function formatTo24H(dateStr) {
        if (!dateStr) return "00ì‹œ 00ë¶„";
        const timePart = dateStr.split(' ')[1];
        if (!timePart) return "00ì‹œ 00ë¶„";
        const [hour, min] = timePart.split(':');
        return `${hour.padStart(2, '0')}ì‹œ ${min.padStart(2, '0')}ë¶„`;
    }

    function renderDashboard(data) {
        const dashboard = document.getElementById('dashboard-content');
        dashboard.innerHTML = '';
        const groups = {};
        Object.entries(data).forEach(([key, val]) => {
            const dateOnly = val.date.split(' ')[0];
            if (!groups[dateOnly]) groups[dateOnly] = [];
            groups[dateOnly].push({ key, ...val });
        });
        Object.keys(groups).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
            const students = groups[date].sort((a, b) => new Date(b.date.replace(/-/g, '/')) - new Date(a.date.replace(/-/g, '/')));
            const groupSection = document.createElement('div');
            groupSection.className = 'date-group';
            groupSection.innerHTML = `
                <div class="date-header" onclick="this.nextElementSibling.classList.toggle('collapsed')"><span>ğŸ“… ${date} ëª…ë‹¨</span><span>ì´ ${students.length}ëª… ì‘ì‹œ (ìµœì‹ ìˆœ) â–¼</span></div>
                <div class="date-content"><table><thead><tr><th>ì‹œê°„</th><th>ì´ë¦„</th><th>ê³¼ëª©</th><th>íšŒì°¨</th><th>ì ìˆ˜</th><th>ì‘ì—…</th></tr></thead><tbody>
                ${students.map(s => `<tr><td style="font-weight:700;">${formatTo24H(s.date)}</td><td><strong>${s.name}</strong></td><td>${s.subject}</td><td>${s.round}</td><td style="color:var(--primary); font-weight:900;">${s.score}ì </td>
                <td><button class="btn-view" onclick='showDetails(${JSON.stringify(s).replace(/'/g, "&apos;")})'>ê²°ê³¼ ë¦¬í¬íŠ¸</button><button class="btn-del" onclick="deleteRecord('${s.key}')" style="margin-left:8px;">ì‚­ì œ</button></td></tr>`).join('')}
                </tbody></table></div>`;
            dashboard.appendChild(groupSection);
        });
    }

    let currentStep = 0; let totalSteps = 0; let isOneByOneMode = false;

    window.showDetails = (data) => {
        isOneByOneMode = false;
        document.getElementById('modal-frame').classList.remove('mode-active-one');
        const content = document.getElementById('modal-inner-content');
        if (!data.wrongList) { alert("ìƒì„¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        totalSteps = data.wrongList.length; currentStep = 0;

        let html = `<div id="student-report-header" style="background:var(--primary); color:white; padding:30px; border-radius:20px; margin-bottom:40px;"><div style="font-size:1.5rem; font-weight:900;">${data.name} í•™ìƒ ë¶„ì„ ë¦¬í¬íŠ¸ (${data.score}ì )</div></div>`;

        html += data.wrongList.map((item, i) => {
            const isCorrect = item.isCorrect === true;
            const badgeClass = isCorrect ? 'badge-correct' : 'badge-wrong';
            const statusIcon = isCorrect ? 'âœ…' : 'âŒ';
            
            let optionsHtml = '';
            if(item.options && Array.isArray(item.options)) {
                optionsHtml = `<div class="q-options-area"><strong>ì‹¤ì œ ë³´ê¸°</strong><br>${item.options.map((opt, idx) => `<span class="option-item">${idx+1}. ${opt}</span>`).join('')}</div>`;
            }
            
            return `
                <div class="result-card ${i === 0 ? 'active' : ''}" id="card-${i}">
                    <div class="card-top-row">
                        <div class="q-number-badge ${badgeClass}">${statusIcon} Question ${i+1}</div>
                        <div class="ans-correct-line">ì •ë‹µ í•´ì„¤: ${item.correct}</div>
                    </div>
                    <div class="q-title">Q. ${item.q}</div>
                    ${optionsHtml}
                    <div class="student-ans-line">í•™ìƒ ë‹µë³€ ê¸°ë¡: ${item.user || 'ë¯¸ì…ë ¥'}</div>
                    <div class="exp-box"><strong>ğŸ“–í•´ì„¤</strong><br>${item.explain || 'í•´ì„¤ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                </div>
            `;
        }).join('');

        content.innerHTML = html;
        document.getElementById('result-modal').style.display = 'block';
        document.querySelector('.modal-scroll-area').scrollTop = 0;
        updatePageIndicator();
    };

    window.updateModalFont = (val) => {
        document.documentElement.style.setProperty('--modal-q-size', val + 'rem');
        document.documentElement.style.setProperty('--modal-exp-size', (val * 0.75) + 'rem');
        document.getElementById('modal-q-val').innerText = val + 'rem';
    };

    window.toggleDisplayMode = () => { isOneByOneMode = !isOneByOneMode; const frame = document.getElementById('modal-frame'); if(isOneByOneMode) { frame.classList.add('mode-active-one'); document.querySelector('.modal-scroll-area').scrollTop = 0; } else { frame.classList.remove('mode-active-one'); } };
    window.changeStep = (dir) => { const next = currentStep + dir; if (next >= 0 && next < totalSteps) { document.getElementById(`card-${currentStep}`).classList.remove('active'); currentStep = next; document.getElementById(`card-${currentStep}`).classList.add('active'); document.querySelector('.modal-scroll-area').scrollTop = 0; updatePageIndicator(); } };
    function updatePageIndicator() { document.getElementById('page-indicator').innerText = `${currentStep + 1} / ${totalSteps}`; }
    window.closeModal = () => { document.getElementById('result-modal').style.display = 'none'; };
    window.updateAdminStyle = (type, val) => { document.documentElement.style.setProperty('--admin-font-size', val + 'px'); document.getElementById('admin-size-val').innerText = val + 'px'; };
    window.deleteRecord = (key) => { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) remove(ref(database, `exam_results/${key}`)); };
    window.logout = () => { sessionStorage.removeItem('admin_auth'); location.replace('index.html'); };
    window.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); if(isOneByOneMode) { if(e.key === 'ArrowRight') changeStep(1); if(e.key === 'ArrowLeft') changeStep(-1); } });
</script>
</body>
</html>