<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>보안 인증</title>
    <link rel="stylesheet" href="../index.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* [추가] 외부 브라우저 버튼 - 기존 디자인에 영향을 주지 않도록 절대 좌표로 띄웁니다. */
        .external-link-btn {
            display: none;
            width: 100%;
            background: #fee500;
            color: #3c1e1e;
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: bold;
            border: 1px solid #e6cf00;
            cursor: pointer;
            box-sizing: border-box;
        }

        /* 기존 디자인 유지 */
        .auth-modal {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            max-width: 420px;
            width: 95%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        }

        /* 교실 선택 레이아웃 */
        .class-selector {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 6px;
            margin: 8px 0 15px 0;
        }
        .class-option {
            flex: 0 0 calc(14% - 6px);
            min-width: 45px; 
            position: relative;
        }
        .class-option input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            width: 1px;
            height: 1px;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
            pointer-events: none; /* 아이폰 클릭 간섭 방지 핵심 배선 */
        }
        .class-label {
            display: block;
            padding: 10px 0;
            background: #f1f5f9;
            border: 2px solid transparent;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            text-align: center;
            box-sizing: border-box;
        }
        .class-option input:checked + .class-label {
            background: #eff6ff;
            border-color: #2563eb;
            color: #2563eb;
        }

        /* 공통 입력창 스타일 */
        input[type="text"], input[type="password"] {
            width: 100%;
            height: 45px;
            margin-bottom: 10px;
            padding: 0 15px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            height: 50px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            body { 
                padding: 0; margin: 0; 
                display: flex; 
                align-items: flex-start;
                justify-content: center; 
                height: 100vh;
                padding-top: 20px;
            }
            .auth-modal {
                width: 90% !important;
                padding: 20px 15px !important;
            }
            .auth-modal h2 { font-size: 1.5rem !important; margin-top: 5px; }
            .auth-modal p { font-size: 0.9rem !important; margin-bottom: 10px !important; }
            
            .class-option {
                flex: 0 0 calc(23% - 6px);
                min-width: 60px; 
                margin-bottom: 4px;
            }
            .class-label {
                padding: 8px 0;
                font-size: 0.95rem; 
            }
            
            input[type="text"], input[type="password"] {
                height: 42px !important;
                font-size: 1rem !important;
                margin-bottom: 8px !important;
            }
            button {
                height: 48px !important;
                font-size: 1.1rem !important;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body oncontextmenu="return false" onselectstart="return false" ondragstart="return false">
    <div class="auth-overlay">
        <div class="auth-modal">
            <div id="kakaoBtn" class="external-link-btn" onclick="exitToExternal()">
                ⚠️ 카톡 이용 시 사파리/크롬 열기
            </div>

            <h2 onclick="handleAdminClick()" style="user-select: none; cursor: default;">학생 인증</h2>
            <p>정보를 정확히 입력하세요.</p>
            
            <div style="text-align:left; font-size:0.8rem; font-weight:700; color:#64748b; margin-bottom:5px; margin-left:5px;">교실 선택</div>
            <div class="class-selector">
                <label class="class-option"><input type="radio" name="classSelect" value="501"><span class="class-label">501</span></label>
                <label class="class-option"><input type="radio" name="classSelect" value="601"><span class="class-label">601</span></label>
                <label class="class-option"><input type="radio" name="classSelect" value="602"><span class="class-label">602</span></label>
                <label class="class-option"><input type="radio" name="classSelect" value="603"><span class="class-label">603</span></label>
                <label class="class-option"><input type="radio" name="classSelect" value="701"><span class="class-label">701</span></label>
                <label class="class-option"><input type="radio" name="classSelect" value="702"><span class="class-label">702</span></label>
                <label class="class-option"><input type="radio" name="classSelect" value="703"><span class="class-label">703</span></label>
            </div>

            <input type="text" id="userNameInput" placeholder="성함 (예: 홍길동)">
            <input type="password" id="pwInput" placeholder="Password">
            
            <button id="authBtn" onclick="handleAuth()">인증 및 시작하기</button>
            <p id="errorMsg" style="display:none; color:red; margin-top:5px; font-size:0.85rem;">정보가 올바르지 않습니다.</p>
        </div>
    </div>

    <div id="admin-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:15px; text-align:center; box-shadow:0 0 20px rgba(0,0,0,0.5); width:300px;">
            <h3 style="margin-bottom:20px; color:#2563eb;">관리자 인증</h3>
            <input type="password" id="admin-pw-input" placeholder="비밀번호 입력" style="width:90%; padding:10px; font-size:1.2rem; border:2px solid #ddd; border-radius:8px; margin-bottom:20px; text-align:center;">
            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="checkAdminPassword()" style="padding:10px 20px; background:#2563eb; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">확인</button>
                <button onclick="closeAdminModal()" style="padding:10px 20px; background:#eee; color:#666; border:none; border-radius:8px; cursor:pointer;">취소</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
    // [추가] 카톡 감지 및 탈출 함수
    (function() {
        if (navigator.userAgent.toLowerCase().indexOf('kakaotalk') > -1) {
            document.getElementById('kakaoBtn').style.display = 'block';
        }
    })();

    function exitToExternal() {
    // 1. 목적지 주소 설정
    const currentHref = window.location.href;
    const targetUrl = currentHref.split('/start/')[0] + '/index.html';
    const ua = navigator.userAgent.toLowerCase();

    if (ua.indexOf('iphone') > -1 || ua.indexOf('ipad') > -1 || ua.indexOf('ipod') > -1) {
        // [아이폰 정밀 수리] 가상 앵커(Anchor)를 만들어 시스템이 '직접 클릭'으로 인식하게 합니다.
        const safariUrl = targetUrl + (targetUrl.includes('?') ? '&' : '?') + 'open_external_browser=1';
        
        // 투명한 가짜 링크를 하나 만듭니다.
        const a = document.createElement('a');
        a.href = safariUrl;
        a.style.display = 'none';
        document.body.appendChild(a);
        
        // 아이폰 시스템에게 이 링크가 클릭되었다고 신호를 보냅니다.
        a.click();
        
        // 사용 후 가짜 링크 제거
        document.body.removeChild(a);

    } else if (ua.indexOf('android') > -1) {
        // [안드로이드 순정 유지] 선생님께서 검증하신 배선 그대로 유지
        location.href = 'intent://' + targetUrl.replace(/https?:\/\//i, '') + '#Intent;scheme=http;package=com.android.chrome;end';
    } else {
        window.location.href = targetUrl;
    }
}

    // --- 이하 사장님 원본 로직 (수정 금지) ---
    const firebaseConfig = {
        apiKey: "AIzaSyB3lciTRWoJ1aXQQJH6JgNC4aJnXj6Ewog",
        authDomain: "khj-cbtbase.firebaseapp.com",
        databaseURL: "https://khj-cbtbase-default-rtdb.firebaseio.com",
        projectId: "khj-cbtbase",
        storageBucket: "khj-cbtbase.firebasestorage.app",
        messagingSenderId: "430706982133",
        appId: "1:430706982133:web:d0bf4cb620f1c7d263d9bc"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function sendAdminLog(status, inputPw) {
        const now = new Date();
        const timeStr = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()} ${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
        const studentName = localStorage.getItem('studentName') || '이름미입력';
        const studentClass = localStorage.getItem('studentClass') || '반미선택';
        const logRef = database.ref('admin_access_logs');
        const newLogRef = logRef.push();
        return newLogRef.set({
            date: timeStr,
            name: studentName,
            class: studentClass,
            status: status,
            attemptPw: status === "FAIL" ? inputPw : "****",
            device: navigator.userAgent
        });
    }

    setInterval(function() { debugger; }, 100);
    sessionStorage.clear();

    let adminClickCount = 0;
    let adminClickTimer = null;

    function handleAdminClick() {
        adminClickCount++;
        clearTimeout(adminClickTimer);
        adminClickTimer = setTimeout(() => { adminClickCount = 0; }, 2000);
        if (adminClickCount >= 5) {
            document.getElementById('admin-modal').style.display = 'flex';
            document.getElementById('admin-pw-input').focus();
            adminClickCount = 0;
        }
    }

    function closeAdminModal() {
        document.getElementById('admin-modal').style.display = 'none';
        document.getElementById('admin-pw-input').value = '';
    }

    function checkAdminPassword() {
        const pw = document.getElementById('admin-pw-input').value;
        const _0x4f2 = (s) => s.split('').reverse().join('');
        const _0x91a = parseInt(_0x4f2("8712351"));
        const _0x22b = (Math.pow(10, 6) * 1.5) + 32178;
        if (pw && Number(pw) === _0x91a && (Number(pw) ^ 0) === _0x22b) {
            sendAdminLog("SUCCESS", "").then(function() {
                setTimeout(function() {
                    sessionStorage.setItem('admin_auth', 'granted');
                    window.location.href = "../admin.html";
                }, 200); 
            }).catch(function() {
                sessionStorage.setItem('admin_auth', 'granted');
                window.location.href = "../admin.html";
            });
        } else {
            sendAdminLog("FAIL", pw).then(function() {
                setTimeout(function() {
                    alert("인증에 실패했습니다.");
                    closeAdminModal();
                }, 200);
            }).catch(function() {
                alert("인증에 실패했습니다.");
                closeAdminModal();
            });
        }
    }

    function handleAuth() {
        const userName = document.getElementById('userNameInput').value.trim();
        const pwInput = document.getElementById('pwInput').value;
        const classRadio = document.querySelector('input[name="classSelect"]:checked');
        const userClass = classRadio ? classRadio.value : "";
        if (userClass === "") { alert("교실을 선택해 주세요."); return; }
        if (userName === "") { alert("성함을 입력해 주세요."); return; }
        if (pwInput === "") { alert("비밀번호를 입력해 주세요."); return; }
        if (pwInput === String.fromCharCode(48, 57, 51, 54)) {
            localStorage.setItem('studentName', userName);
            localStorage.setItem('studentClass', userClass);
            sessionStorage.setItem('auth_status', 'verified');
            window.location.replace('../index.html');
        } else {
            document.getElementById('errorMsg').style.display = 'block';
        }
    }

    document.getElementById('admin-pw-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') checkAdminPassword();
    });

    window.addEventListener('keydown', function(e) { 
        if (e.key === 'Enter') {
            if (document.getElementById('admin-modal').style.display !== 'flex') {
                handleAuth();
            }
        }
    });

    ['contextmenu', 'selectstart', 'copy', 'paste', 'cut', 'dragstart'].forEach(event => {
        document.addEventListener(event, e => e.preventDefault(), true);
    });
    </script>
</body>
</html>